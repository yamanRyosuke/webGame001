# Meteor Punch Garden — 仕様書（Claude-Code実装向け / v0.1）
※本書はユーザー提供の「仕様書テンプレート（Claude-Code実装向け / Webカジュアルゲーム）」に沿って作成【fileciteturn0file0】  
※まずは **MVP（最小実装）** を迷わず作れる粒度を優先。追加案は末尾にまとめる。

---

## 0. 基本情報
- タイトル: Meteor Punch Garden（仮）
- リポジトリ: （未定 / 後で記入）
- 技術: **Vite + TypeScript + Three.js**（WebGL / 3D）
- 対応端末: **PC優先** → スマホ対応（最終的に両対応）
- 画面向き: **横（Landscape）推奨**（スマホも横固定）
- 基準解像度: 1280x720（CanvasをCSSでスケール / 画面比が違う場合はレターボックス）

---

## 1. 用語集
- **ジオラマ**: 立方体の小さな箱庭ステージ（浮島）。
- **原生生物（Creature）**: 守る対象。操作不可。うろうろ歩く。
- **隕石（Meteor）**: 空から落下する脅威。地面に着弾すると爆発。
- **予兆（Telegraph）**: 落下地点に表示される着弾予告（円/影など）。
- **ジャンプパンチ（JumpPunch）**: プレイヤーの空中攻撃。隕石に当てると破壊する。
- **Wave**: 隕石が一定の強度で降る時間帯。時間経過で難易度が上がる。

---

## 2. ゲーム状態（State）
### 2.1 State一覧
- Boot: アセット読み込み、初期化
- Title: タイトル画面
- Play: ゲーム中
- Result: 結果表示（クリア / 失敗）
- (Option): 設定（任意 / MVPでは省略可）

### 2.2 状態遷移（文章）
- Boot → Title（ロード完了）
- Title → Play（クリック/タップで開始）
- Play → Result（クリア or 失敗）
- Result → Play（リトライ）
- Result → Title（タイトルへ）

---

## 3. 画面仕様（UI）
### 3.1 画面レイアウト
- Safe area対応（スマホノッチ）: **する**（UIは上下に余白を確保）
- UI要素（MVP）
  - 左上: **残り時間**（例: 00:45）
  - 右上: **生物残数**（例: 3/3）
  - 右下: **ジャンプ/パンチ（モバイル用）**（MVPでは簡易ボタン）
  - 左下: **移動スティック（モバイル用）**（MVPでは簡易バーチャルスティック）
  - Title/Result: Start / Retry / Title ボタン

### 3.2 UIの見た目
- フォント: システムフォントでOK（後で差し替え）
- 最小タップ領域: 48px以上
- アニメーション方針: フェード + 軽いポップ（scale 0.95→1.0）

---

## 4. 入力仕様
### 4.1 入力デバイス
- PC:
  - 移動: WASD / 矢印キー
  - ジャンプ: Space
  - パンチ: J もしくは 左クリック
- スマホ:
  - 左: バーチャルスティック（移動）
  - 右: ジャンプボタン、パンチボタン（※空中のみパンチ有効）

### 4.2 入力の詳細
- 移動入力（2Dベクトル）をプレイヤーのXZ平面移動に反映
- ジャンプ:
  - 地上のみ発動（isGrounded=true）
  - ジャンプ中にパンチ入力が入ったら **JumpPunch** を開始
- パンチ:
  - 空中でのみ有効
  - 発動後 **0.25秒間** 攻撃判定を有効（後述）

### 4.3 入力の例外
- UI上での入力はゲーム入力に伝播しない
- スマホ: マルチタッチは「左スティック + 右ボタン」の2点まで対応（それ以外は無視）

---

## 5. ゲームルール（最重要）
### 5.1 目的
制限時間内、空から降る隕石を **ジャンプパンチで破壊** し、原生生物を規定数以上守りきる。

### 5.2 主要パラメータ（MVP）
| 項目 | 値（MVP） | 備考 |
|---|---:|---|
| 制限時間 | 60秒 | クリア条件 |
| 初期生物数 | 3体 | 0で失敗 |
| プレイヤー移動速度 | 6.0 units/s | XZ平面 |
| ジャンプ初速 | 8.5 units/s | 物理ベース or 疑似 |
| 重力 | -18 units/s^2 | 体感調整用 |
| パンチ判定時間 | 0.25s | 発動後固定 |
| パンチ判定半径 | 0.6 units | 球判定 |
| パンチ前方オフセット | 0.7 units | プレイヤー前方 |
| Meteor落下予兆時間 | 1.0s | Telegraph表示 |
| Meteor落下速度 | 12 units/s | 空から落下 |
| Meteor爆発半径 | 1.6 units | 着弾時 |
| 爆発ダメージ | 生物:即死 / プレイヤー:ノックバック | MVP |

> World Units: ステージ天面の一辺を **10 units** とする（目安）。

### 5.3 オブジェクト仕様

#### Player
- 役割: 隕石迎撃
- 見た目: 宇宙服っぽいデフォルメ（仮）
- サイズ: 半径0.5（カプセル/円柱で当たり）
- 操作:
  - 地上: 移動 + ジャンプ
  - 空中: 移動（空中制御係数0.6） + パンチ
- 移動範囲: ステージ天面上（落下あり）
- 無敵時間: なし（MVP）※被弾で短い硬直のみ
- 被弾:
  - Meteor直撃 or 爆発範囲: ノックバック（後方+上方向）
  - ノックバック中: 0.4秒操作不可

#### Creature（原生生物）
- 役割: 守られる対象
- 見た目: ぷにっとした小人形（3体同種）
- サイズ: 半径0.35（球/カプセル）
- 生成: ステージ開始時に3体スポーン（固定スポーン点）
- 挙動:
  - 通常: ランダムウォーク（速度1.2 units/s）
  - 危険反応: 予兆が近い（半径2.5以内）と **逃げ**（速度2.0、予兆中心から反対方向へ）
- 破棄条件: 爆発範囲に入る or 隕石直撃で「死亡」扱い（非表示/消滅）
- 当たり判定: プレイヤーとは物理衝突しない（押し合わない）

#### Meteor（隕石）
- 種別（MVPは1種のみ）
  - SmallMeteor
- 見た目: 発光する岩（炎の尾）
- 生成:
  - 上空（y=+12）に生成し、目標地点に向かって落下
  - 生成前にTelegraphを表示（落下地点の円）
- サイズ:
  - 本体当たり: 半径0.45
  - Telegraph円: 半径0.7（視覚用）
- 破棄:
  - パンチに当たったら **空中で破壊**（破片+SE）
  - 地面に着弾したら **爆発**（範囲内のCreatureを即死）
- 例外:
  - 破壊された場合は爆発しない（破片演出のみ）

#### Stage（ジオラマ）
- 形状: 立方体（天面10x10 units）
- 地形: 高低差（崖/段差）はMVPでは「少し」入れる程度
- 落下:
  - 天面外へ出ると落下（y < -10で死亡→リスポーン or 失敗加算）
  - MVP: 落下したら **0.8秒後に中央へリスポーン**（ペナルティとして残り時間-3秒）

### 5.4 勝敗条件
- クリア条件:
  - タイマーが0になるまで生存し、かつ生物が **1体以上** 生存
- 失敗条件:
  - 生物が **0体**
  - または残り時間がある状態でも「落下ペナルティ」を3回受けた（任意 / MVPではOFF可）
- 同時に満たした場合:
  - 失敗（生物0）を優先

### 5.5 難易度調整（MVP）
- 時間経過で増える要素:
  - 0〜20秒: 1.2秒ごとに1個
  - 20〜40秒: 0.9秒ごとに1個
  - 40〜60秒: 0.7秒ごとに1個
- 乱数:
  - 落下地点はステージ天面内（端から0.8units内側に制限）
  - Creature付近に偏りすぎないよう、直近2回の地点から距離2.0以内は避ける（可能なら）
- 初心者救済:
  - 最初の10秒間は爆発半径を1.2に減少（任意）

---

## 6. 演出仕様
### 6.1 フィードバック（必須）
- 成功時（隕石破壊）:
  - ヒットストップ: 0.06秒
  - 破片パーティクル + フラッシュ
  - SE: 「パンチヒット」「岩割れ」
- 失敗時（生物が消滅）:
  - 小さなポフっと消える
  - 画面シェイク小（0.15秒）
  - SE: 「しゅん…」系
- 連続成功:
  - 連続破壊数（combo）をUIに小さく表示（MVPでは任意）
- UIの反応:
  - 生物残数が減った瞬間に軽くポップ

### 6.2 画面遷移
- フェード時間: 0.25秒（Title→Play / Play→Result）
- Result表示:
  - クリア: 「SURVIVED!」+ 生物残数
  - 失敗: 「EXTINCT…」+ リトライ誘導

---

## 7. サウンド仕様
- BGM:
  - Title: 1曲（ループ）
  - Play: 1曲（ループ）
- SE:
  - Punch
  - MeteorBreak
  - MeteorImpact
  - CreatureHurt/Die
  - UI Click
- 同時発音制限:
  - MeteorBreakは同時3つまで（ミックス破綻防止）
- Webの自動再生制限:
  - 最初の入力後にAudioContext開始（TitleのStartで初期化）

---

## 8. データ保存
- 保存するもの:
  - ハイスコア（生存秒数 or 残生物数）
  - サウンドON/OFF
- 保存先: localStorage
- キー一覧:
  - mpg_highscore
  - mpg_sound_enabled
- 破損時フォールバック:
  - parse失敗時は初期値に戻す

---

## 9. パフォーマンス要件
- 目標FPS: 60（最低30）
- 最大同時オブジェクト数（MVP目安）:
  - Meteor: 8
  - Particle: 200（合計）
- アセット容量目安:
  - 10MB以内（MVPはプリミティブ+簡易テクスチャ）
- スマホ負荷対策:
  - 影はOFF（または簡易）
  - パーティクル数を端末性能で減らす（任意）

---

## 10. 実装構成案
### 10.1 ディレクトリ構成案
- src/
  - game/
    - core/
      - StateMachine.ts
      - GameLoop.ts
      - Time.ts
    - three/
      - Renderer.ts
      - SceneFactory.ts
      - CameraController.ts
    - input/
      - InputManager.ts
      - VirtualStick.ts
    - entities/
      - Player.ts
      - Creature.ts
      - Meteor.ts
    - systems/
      - MeteorSpawner.ts
      - CollisionSystem.ts
      - EffectsSystem.ts
      - AudioManager.ts
      - Storage.ts
  - ui/
    - HUD.ts
    - Title.ts
    - Result.ts
  - assets/（任意）

### 10.2 主要クラス/モジュール責務
- GameLoop: requestAnimationFrame、固定Δ or 可変Δでupdate
- StateMachine: Boot/Title/Play/Result管理
- InputManager: PC/モバイル入力の統合、UI入力除外
- MeteorSpawner: 時間経過に応じてスポーン計画
- CollisionSystem:
  - PunchSphere vs Meteor（空中破壊）
  - MeteorImpact → ExplosionSphere vs Creature
- EffectsSystem: 破片/ヒットストップ/シェイク
- AudioManager: BGM/SE、同時数制限
- Storage: localStorageラッパ

---

## 11. テスト観点（最低限）
- PC Chrome / Safari（Mac）/ Edge
- iOS Safari / Android Chrome
- 画面リサイズ（PC）と回転（スマホ横固定）
- 音ON/OFF切替
- 連打（ジャンプ/パンチ）でバグらない
- Meteorが同時多発してもFPSが落ちすぎない
- UI操作がゲーム入力に干渉しない

---

## 12. 受け入れ条件（Definition of Done）
- Title→Play→Result→Retry が通る
- Meteorが予兆→落下→着弾爆発し、Creatureがダメージを受ける
- プレイヤーが **空中パンチでMeteorを破壊** できる
- 60秒守りきればクリア、Creature全滅なら失敗
- スマホで最低限操作できる（移動・ジャンプ・パンチ）
- コンソールエラーが出ない（Known除く）

---

# 付録A: 追加アイデア（MVP後）
- Meteor種類追加（大・分裂・追尾）
- ステージギミック（柱、洞窟、避難所）
- 生物の種別・特性（逃げ足が速い/群れる等）
- コンボ/スコア、リプレイ性
- 1ステージ完結→複数ステージ選択へ
